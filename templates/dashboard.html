{% extends "base.html" %} {% block title %}Dashboard - SalesPro Manager{%
endblock %} {% block header %}
<h2 class="text-2xl font-semibold text-gray-900">Dashboard</h2>
{% endblock %} {% block content %}
<div class="py-6">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                    <i class="fas fa-money-bill-wave text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                        Doanh thu hôm nay
                    </p>
                    <p class="text-2xl font-semibold text-gray-900">
                        {{ "{:,.0f}".format(total_sales) }} VNĐ
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                    <i class="fas fa-shopping-cart text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                        Giao dịch hôm nay
                    </p>
                    <p class="text-2xl font-semibold text-gray-900">
                        {{ total_transactions }}
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                    <i
                        class="fas fa-exclamation-triangle text-white text-xl"
                    ></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                        Sản phẩm sắp hết
                    </p>
                    <p class="text-2xl font-semibold text-gray-900">
                        {{ low_stock_count }}
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-500 rounded-md p-3">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">
                        Tổng doanh thu
                    </p>
                    <p class="text-2xl font-semibold text-gray-900">
                        {% set total_all_sales = namespace(value=0) %} {% for
                        sale in recent_sales %} {% set total_all_sales.value =
                        total_all_sales.value + sale.total_amount %} {% endfor
                        %} {{ "{:,.0f}".format(total_all_sales.value) }} VNĐ
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Sales Chart -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                Doanh thu 7 ngày qua
            </h3>
            <div class="h-64">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Recent Sales -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                Giao dịch gần đây
            </h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                            >
                                Mã
                            </th>
                            <th
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                            >
                                Thời gian
                            </th>
                            <th
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                            >
                                Tổng tiền
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for sale in recent_sales %}
                        <tr>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <a
                                    href="{{ url_for('main.sale_detail', id=sale.id) }}"
                                    class="text-blue-600 hover:text-blue-900"
                                >
                                    {{ sale.sale_code }}
                                </a>
                            </td>
                            <td
                                class="px-4 py-3 whitespace-nowrap text-sm text-gray-500"
                            >
                                {{ sale.sale_date.strftime('%H:%M') }}
                            </td>
                            <td
                                class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900"
                            >
                                {{ "{:,.0f}".format(sale.total_amount) }} VNĐ
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Thao tác nhanh</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a
                href="{{ url_for('main.new_sale') }}"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-md text-center"
            >
                <i class="fas fa-cash-register mr-2"></i>Bán hàng
            </a>
            <a
                href="{{ url_for('main.add_product') }}"
                class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-md text-center"
            >
                <i class="fas fa-plus mr-2"></i>Thêm sản phẩm
            </a>
            <a
                href="{{ url_for('main.add_customer') }}"
                class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-md text-center"
            >
                <i class="fas fa-user-plus mr-2"></i>Thêm khách hàng
            </a>
            <a
                href="{{ url_for('main.reports') }}"
                class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-3 px-4 rounded-md text-center"
            >
                <i class="fas fa-chart-pie mr-2"></i>Xem báo cáo
            </a>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        /* ========= CHART ========= */
        const canvas = document.getElementById('salesChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ last_7_days|tojson }},
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: {{ sales_data|tojson }},
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value =>
                                    value.toLocaleString('vi-VN') + ' VNĐ'
                            }
                        }
                    }
                }
            });
        }

        /* ========= SOCKET ========= */
        const socket = io();

        socket.on('sale_update', function () {
            fetch('/api/sales/today')
                .then(res => res.json())
                .then(data => {
                    const el = document.getElementById('today-sales');
                    if (el) {
                        el.textContent =
                            new Intl.NumberFormat('vi-VN')
                            .format(data.total_sales) + ' VNĐ';
                    }
                });
        });

    });
</script>
{% endblock %}
