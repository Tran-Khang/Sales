<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o - Sales Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div id="navbar"></div>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üìä B√°o c√°o & Th·ªëng k√™</h1>
        
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">T·ª´ ng√†y</label>
                    <input type="date" id="dateFrom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ƒê·∫øn ng√†y</label>
                    <input type="date" id="dateTo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex items-end">
                    <button id="filterBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold transition">
                        üîç L·ªçc d·ªØ li·ªáu
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-500 text-sm mb-2">T·ªïng doanh thu</h3>
                <p id="summaryRevenue" class="text-3xl font-bold text-green-600">0ƒë</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-500 text-sm mb-2">S·ªë ƒë∆°n h√†ng</h3>
                <p id="summaryOrders" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-gray-500 text-sm mb-2">Trung b√¨nh/ƒë∆°n</h3>
                <p id="summaryAverage" class="text-3xl font-bold text-purple-600">0ƒë</p>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Doanh thu theo ng√†y</h2>
                <canvas id="dailyRevenueChart"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Top s·∫£n ph·∫©m b√°n ch·∫°y</h2>
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
        
        <!-- Sales Table -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Chi ti·∫øt ƒë∆°n h√†ng</h2>
                <input type="text" id="searchReport" placeholder="üîç T√¨m ki·∫øm..." 
                       class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div id="salesTable"></div>
        </div>
    </div>

    <script type="module">
        import { checkAuth } from '../js/auth.js';
        import { setupNavbar, formatCurrency, formatDate, showLoading } from '../js/ui.js';
        import { getSales } from '../js/api.js';
        
        await checkAuth();
        setupNavbar('reports');
        
        let allSales = [];
        let filteredSales = [];
        let dailyChart = null;
        let productsChart = null;
        
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('dateTo').valueAsDate = today;
        document.getElementById('dateFrom').valueAsDate = thirtyDaysAgo;
        
        // Load sales data
        async function loadSales(filters = {}) {
            try {
                const data = await getSales(filters);
                allSales = data.sales;
                filteredSales = allSales;
                
                updateSummary();
                updateCharts();
                renderTable(filteredSales);
                
            } catch (error) {
                console.error('Error loading sales:', error);
            }
        }
        
        // Update summary cards
        function updateSummary() {
            const totalRevenue = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const totalOrders = filteredSales.length;
            const averageOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            document.getElementById('summaryRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('summaryOrders').textContent = totalOrders;
            document.getElementById('summaryAverage').textContent = formatCurrency(averageOrder);
        }
        
        // Update charts
        function updateCharts() {
            // Daily revenue chart
            const dailyData = {};
            filteredSales.forEach(sale => {
                const date = sale.created_at.split('T')[0];
                dailyData[date] = (dailyData[date] || 0) + sale.total;
            });
            
            const dates = Object.keys(dailyData).sort();
            const revenues = dates.map(d => dailyData[d]);
            
            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(document.getElementById('dailyRevenueChart'), {
                type: 'line',
                data: {
                    labels: dates.map(d => new Date(d).toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: revenues,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
            
            // Top products chart
            const productSales = {};
            filteredSales.forEach(sale => {
                if (!productSales[sale.product_name]) {
                    productSales[sale.product_name] = 0;
                }
                productSales[sale.product_name] += sale.total;
            });
            
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (productsChart) productsChart.destroy();
            productsChart = new Chart(document.getElementById('topProductsChart'), {
                type: 'bar',
                data: {
                    labels: topProducts.map(p => p[0]),
                    datasets: [{
                        label: 'Doanh thu (VNƒê)',
                        data: topProducts.map(p => p[1]),
                        backgroundColor: 'rgba(99, 102, 241, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y'
                }
            });
        }
        
        // Render sales table
        function renderTable(sales) {
            const container = document.getElementById('salesTable');
            
            if (sales.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">S·∫£n ph·∫©m</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">SL</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">T·ªïng ti·ªÅn</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${sales.map(sale => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm">#${sale.id}</td>
                                    <td class="px-4 py-3 text-sm">${sale.product_name}</td>
                                    <td class="px-4 py-3 text-sm font-semibold">${sale.quantity}</td>
                                    <td class="px-4 py-3 text-sm font-bold text-green-600">${formatCurrency(sale.total)}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">${formatDate(sale.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Filter button
        document.getElementById('filterBtn').addEventListener('click', () => {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            loadSales({ date_from: dateFrom, date_to: dateTo });
        });
        
        // Search in table
        let searchTimeout;
        document.getElementById('searchReport').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const keyword = e.target.value.toLowerCase();
                if (keyword) {
                    filteredSales = allSales.filter(s => 
                        s.product_name.toLowerCase().includes(keyword) ||
                        s.id.toString().includes(keyword)
                    );
                } else {
                    filteredSales = allSales;
                }
                renderTable(filteredSales);
            }, 300);
        });
        
        // Initial load
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        loadSales({ date_from: dateFrom, date_to: dateTo });
    </script>
</body>
</html>