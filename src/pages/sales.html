<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°n h√†ng - Sales Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="navbar"></div>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üõí B√°n h√†ng</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Create Sale Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                    <h2 class="text-xl font-bold mb-4">T·∫°o ƒë∆°n h√†ng m·ªõi</h2>
                    <form id="saleForm" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">S·∫£n ph·∫©m</label>
                            <select id="productSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                            </select>
                        </div>
                        
                        <div id="productInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-sm text-gray-700">Gi√°: <span id="infoPrice" class="font-semibold"></span></p>
                            <p class="text-sm text-gray-700">T·ªìn kho: <span id="infoStock" class="font-semibold"></span></p>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">S·ªë l∆∞·ª£ng</label>
                            <input type="number" id="quantity" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-600 text-sm mb-1">T·ªïng ti·ªÅn</p>
                            <p id="totalAmount" class="text-3xl font-bold text-green-600">0ƒë</p>
                        </div>
                        
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold transition">
                            ‚úÖ T·∫°o ƒë∆°n h√†ng
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Sales History -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üìã L·ªãch s·ª≠ ƒë∆°n h√†ng</h2>
                        <button id="refreshBtn" class="text-indigo-600 hover:text-indigo-800 font-semibold">
                            üîÑ L√†m m·ªõi
                        </button>
                    </div>
                    
                    <!-- Search -->
                    <input type="text" id="searchSales" placeholder="üîç T√¨m ki·∫øm ƒë∆°n h√†ng..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                    
                    <div id="salesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { checkAuth } from '../js/auth.js';
        import { setupNavbar, formatCurrency, formatDate, showNotification, showLoading } from '../js/ui.js';
        import { getProducts, getSales, createSale } from '../js/api.js';
        
        await checkAuth();
        setupNavbar('sales');
        
        let products = [];
        let sales = [];
        
        // Load products for select
        async function loadProducts() {
            try {
                const data = await getProducts();
                products = data.products;
                
                const select = document.getElementById('productSelect');
                select.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>' + 
                    products.map(p => `
                        <option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">
                            ${p.name} - ${formatCurrency(p.price)} (C√≤n: ${p.stock})
                        </option>
                    `).join('');
                    
            } catch (error) {
                showNotification('L·ªói t·∫£i danh s√°ch s·∫£n ph·∫©m', 'error');
            }
        }
        
        // Load sales history
        async function loadSales(searchKeyword = '') {
            showLoading('salesList');
            try {
                const data = await getSales({ search: searchKeyword });
                sales = data.sales;
                renderSales(sales);
            } catch (error) {
                showNotification('L·ªói t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng', 'error');
            }
        }
        
        // Render sales
        function renderSales(salesData) {
            const container = document.getElementById('salesList');
            
            if (salesData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">S·∫£n ph·∫©m</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">S·ªë l∆∞·ª£ng</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">T·ªïng ti·ªÅn</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${salesData.map(sale => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm">${sale.product_name}</td>
                                    <td class="px-4 py-3 text-sm font-semibold">${sale.quantity}</td>
                                    <td class="px-4 py-3 text-sm font-bold text-green-600">${formatCurrency(sale.total)}</td>
                                    <td class="px-4 py-3 text-sm text-gray-500">${formatDate(sale.created_at)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Product select change - show info and calculate total
        const productSelect = document.getElementById('productSelect');
        const quantityInput = document.getElementById('quantity');
        const productInfo = document.getElementById('productInfo');
        const totalAmount = document.getElementById('totalAmount');
        
        function updateTotal() {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (selectedOption.value && quantity > 0) {
                const price = parseFloat(selectedOption.dataset.price);
                const total = price * quantity;
                totalAmount.textContent = formatCurrency(total);
            } else {
                totalAmount.textContent = '0ƒë';
            }
        }
        
        productSelect.addEventListener('change', (e) => {
            const option = e.target.options[e.target.selectedIndex];
            if (option.value) {
                productInfo.classList.remove('hidden');
                document.getElementById('infoPrice').textContent = formatCurrency(option.dataset.price);
                document.getElementById('infoStock').textContent = option.dataset.stock;
                quantityInput.max = option.dataset.stock;
                updateTotal();
            } else {
                productInfo.classList.add('hidden');
            }
        });
        
        quantityInput.addEventListener('input', updateTotal);
        
        // Search sales
        let searchTimeout;
        document.getElementById('searchSales').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadSales(e.target.value);
            }, 300);
        });
        
        // Create sale
        document.getElementById('saleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = parseInt(productSelect.value);
            const quantity = parseInt(quantityInput.value);
            
            if (!productId || !quantity) {
                showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
                return;
            }
            
            try {
                await createSale(productId, quantity);
                showNotification('‚úÖ T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!');
                
                // Reset form
                document.getElementById('saleForm').reset();
                productInfo.classList.add('hidden');
                totalAmount.textContent = '0ƒë';
                
                // Reload data
                await loadProducts();
                await loadSales(document.getElementById('searchSales').value);
                
            } catch (error) {
                showNotification(error.message, 'error');
            }
        });
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadSales(document.getElementById('searchSales').value);
        });
        
        // Initial load
        loadProducts();
        loadSales();
    </script>
</body>
</html>