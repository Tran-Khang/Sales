<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sales Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div id="navbar"></div>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üìä Dashboard</h1>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">T·ªïng doanh thu</p>
                        <p id="totalRevenue" class="text-2xl font-bold text-green-600">0ƒë</p>
                    </div>
                    <div class="text-4xl">üí∞</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">T·ªïng s·∫£n ph·∫©m</p>
                        <p id="totalProducts" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="text-4xl">üì¶</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">T·ªïng ƒë∆°n h√†ng</p>
                        <p id="totalSales" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="text-4xl">üõí</div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">C·∫£nh b√°o t·ªìn kho</p>
                        <p id="lowStockCount" class="text-2xl font-bold text-red-600">0</p>
                    </div>
                    <div class="text-4xl">‚ö†Ô∏è</div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Doanh thu 7 ng√†y g·∫ßn ƒë√¢y</h2>
                <canvas id="revenueChart"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4">Top 5 s·∫£n ph·∫©m b√°n ch·∫°y</h2>
                <canvas id="topProductsChart"></canvas>
            </div>
        </div>
        
        <!-- Low Stock Alerts -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">‚ö†Ô∏è C·∫£nh b√°o t·ªìn kho th·∫•p</h2>
            <div id="lowStockList"></div>
        </div>
    </div>

    <script type="module">
        import { checkAuth } from '../js/auth.js';
        import { setupNavbar, formatCurrency, showLoading } from '../js/ui.js';
        import { getProducts, getSales } from '../js/api.js';
        
        // Check authentication
        await checkAuth();
        setupNavbar('dashboard');
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                const [productsData, salesData] = await Promise.all([
                    getProducts(),
                    getSales()
                ]);
                
                const products = productsData.products;
                const sales = salesData.sales;
                
                // Calculate stats
                const totalRevenue = sales.reduce((sum, sale) => sum + sale.total, 0);
                const totalProducts = products.length;
                const totalSales = sales.length;
                const lowStockProducts = products.filter(p => p.stock < 10);
                
                // Update stats
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('totalSales').textContent = totalSales;
                document.getElementById('lowStockCount').textContent = lowStockProducts.length;
                
                // Revenue chart (last 7 days)
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (6 - i));
                    return d.toISOString().split('T')[0];
                });
                
                const revenueByDay = last7Days.map(day => {
                    return sales
                        .filter(s => s.created_at.startsWith(day))
                        .reduce((sum, s) => sum + s.total, 0);
                });
                
                new Chart(document.getElementById('revenueChart'), {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => new Date(d).toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' })),
                        datasets: [{
                            label: 'Doanh thu (VNƒê)',
                            data: revenueByDay,
                            borderColor: 'rgb(99, 102, 241)',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });
                
                // Top products chart
                const productSales = {};
                sales.forEach(sale => {
                    if (!productSales[sale.product_id]) {
                        productSales[sale.product_id] = {
                            name: sale.product_name,
                            total: 0
                        };
                    }
                    productSales[sale.product_id].total += sale.total;
                });
                
                const topProducts = Object.values(productSales)
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 5);
                
                new Chart(document.getElementById('topProductsChart'), {
                    type: 'bar',
                    data: {
                        labels: topProducts.map(p => p.name),
                        datasets: [{
                            label: 'Doanh thu (VNƒê)',
                            data: topProducts.map(p => p.total),
                            backgroundColor: 'rgba(99, 102, 241, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        indexAxis: 'y'
                    }
                });
                
                // Low stock list
                const lowStockList = document.getElementById('lowStockList');
                if (lowStockProducts.length === 0) {
                    lowStockList.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o c·∫ßn c·∫£nh b√°o</p>';
                } else {
                    lowStockList.innerHTML = lowStockProducts.map(p => `
                        <div class="flex justify-between items-center py-3 border-b">
                            <div>
                                <p class="font-semibold">${p.name}</p>
                                <p class="text-sm text-gray-500">Gi√°: ${formatCurrency(p.price)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-red-600 font-bold">C√≤n ${p.stock}</p>
                                <p class="text-xs text-gray-500">${p.stock === 0 ? 'H·∫æT H√ÄNG' : 'S·∫Øp h·∫øt'}</p>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        loadDashboard();
    </script>
</body>
</html>